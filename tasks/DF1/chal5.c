#include "chal5.h"

Person *persons[10];
Executor *execute;
int counter = 0;

void init()
{
  setvbuf(stdout, 0, 2, 0);
  setvbuf(stdin, 0, 2, 0);
  setvbuf(stderr, 0, 2, 0);
}

void say(Person *person)
{
  printf("Hello my name is %s\n", person->name); 
}

void sayFUN()
{
  int index;
  char tmp[3];
  puts("Enter ur index:");
  read(0, tmp, 3);
  index = atoi(tmp);

  if(index < 0 || index >= 10)
  {
    printf("Bad index\n");
    return;
  }
  if(persons[index])
    persons[index]->say(persons[index]);
}

void addPerson()
{
  if(counter > 10)
  {
    printf("Count of persons are full\n");
    return;
  
  }
  persons[counter] = (Person *)malloc(sizeof(struct Person));
  puts("Enter your name:");
  read(0, persons[counter]->name, 0x8);
  persons[counter]->say = say;
  puts("Success");
  printf("person %d %p\n", counter, persons[counter]);
  counter++; 
}

void exec()
{
  if(execute)
    system("/bin/id");
  else
    puts("Executor is not allocated");
}

void addExec()
{
  if(!execute)
  {
    execute = (Executor *)malloc(sizeof(struct Executor));
    execute->executor = exec;
    printf("executor %p\n", execute);
    puts("Executor allocated!");
  }
  else
    puts("Executor already allocated");

}

void delPersons()
{
  int index; 
  printf("Enter index to free:\n");
  scanf("%d", &index);
  
  if(index < 0 && index >= counter){
    printf("Bad index\n"); 
    return;
  }

  free(persons[index]);
  persons[index] = NULL;
  if(!counter)
    return;
  counter--;
  printf("Successfulky deleted person with index %d\n", index);
}

void delExecutor()
{
  if(execute)
  {
    free(execute);
    execute = NULL;
    puts("Delete executor");
  }
}

void win()
{
  system("/bin/sh");
}

void menu()
{
  puts("[1] allocate Person");
  puts("[2] allocate Executor");
  puts("[3] say Name"); 
  puts("[4] execute Command");
  puts("[5] delete Person");
  puts("[6] delete Executor");
  puts("[7] Exit");
}

int main()
{
  printf("%ld __ %ld", sizeof(struct Executor), sizeof(struct Person));
  int choice, index;
  puts("---------------------");
  puts(" DOUBLE FREEEEEE???  ");
  puts("---------------------");
  while(1)
    {
      menu();
      puts("Enter ur option:");
      scanf("%d", &choice);
      switch(choice)
        {
          case 1:
            addPerson();
            continue;
          case 2:
            addExec();
            continue;
          case 3:
            sayFUN();
            continue;
          case 4:
            exec();
            continue;
          case 5:
            delPersons();
            continue;
          case 6:
            delExecutor();
            continue;
          case 7:
            puts("Bye;)");
            break;
          default:
            puts("Invalid option");
            continue;
        }
      break;
    }
  return 0;
}
